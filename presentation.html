<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>

	<script src="presentation_data/lib/codemirror/lib/codemirror.js"></script>
	<link rel="stylesheet" href="presentation_data/lib/codemirror/lib/codemirror.css">
	<script src="presentation_data/lib/codemirror/mode/javascript/javascript.js"></script>

	<style>
body {
	margin: 0;
	width: 100%;
	height: 100%;
}

.left {
	float: left;
	width: 50%;
}

.right {
	float: right;
	width: 50%;
	height: 100%;
}

iframe {
	width: 100%;
	height: 99vh;
	overflow: hidden;
}

.CodeMirror {
	height: 100vh;
	font-size: large;
	font-weight: bolder;
}
	</style>
</head>
<body>
	<div class="left">
		<textarea id="code_window"></textarea>
	</div>
	<div class="right">
		<iframe id='miframe' frameborder="0" scrolling="no"></iframe>
	</div>

	<script src="presentation_data/manifest.js"></script>
	<script>
var iframe = document.getElementById('miframe');

var myCodeMirror = CodeMirror.fromTextArea(document.getElementById('code_window'),
	{readonly: true, lineWrapping: true, viewportMargin: Infinity});

var slideIndex = 0;
var slideCount = slides.length;
var stepIndex = 0;
var stepCount = 0;

var slideContents;

iframe.addEventListener('load', frameLoaded);
document.addEventListener('keydown', onKeyEvent);
loadSlide(0);

function loadSlide(n) {
	iframe.src = 'presentation_data/' + slides[n];
	slideIndex = n;
}

function frameLoaded() {
	slideContents = iframe.contentDocument.documentElement.outerHTML;
	slideContents = slideContents.replace(/\t/g, '  ');
	stepCount = getStepCount(slideContents);
	if (stepIndex > 0)
		stepIndex = 0;
	if (stepIndex < 0)
		stepIndex = stepCount - 1;
	loadStep(stepIndex);
}

function loadStep(i) {
	stepIndex = i;
	var html = getHTMLforStep(slideContents, i);
	iframe.contentDocument.body.innerHTML = "";
	iframe.contentDocument.write(html);
	//document.getElementById('code_window').innerText = html;
	myCodeMirror.setValue(html);
}

function onKeyEvent(e) {
	if (e.key == 'j' || e.key == 'ArrowRight' || e.key == ' ') {
		if (stepIndex < stepCount - 1) {
			loadStep(stepIndex + 1);
		}
		else if (slideIndex < slideCount - 1) {
			stepIndex = 0;
			loadSlide(slideIndex + 1);
		}
	}
	if (e.key == 'k' || e.key == 'ArrowLeft') {
		if (stepIndex > 0) {
			loadStep(stepIndex - 1);
		}
		else if (slideIndex > 0) {
			stepIndex = -1;
			loadSlide(slideIndex - 1);
		}
	}
}

function getStepCount(html) {
	var lines = html.split('\n');
	var reg = /@(\d+)/;
	var maxStep = 0;

	for (var i = 0; i < lines.length; i++)
		if (reg.test(lines[i]))
			maxStep = Math.max(maxStep, parseInt(lines[i].match(reg)[1]));

	return maxStep + 1;
}

function getHTMLforStep(html, step) {
	var lines = html.split('\n');
	var reg = /@(\d+)/;

	var newLines = [];
	var skipping = false;

	for (var i = 0; i < lines.length; i++) {
		if (reg.test(lines[i])) {
			var start = parseInt(lines[i].match(reg)[1]);
			skipping = start > step;
		}
		else if (!skipping) {
			newLines.push(lines[i]);
		}
	}

	return newLines.join('\n');
}
	</script>
</body>
</html>
